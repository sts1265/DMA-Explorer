<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>DMA Legal Explorer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        :root { 
            --primary: #0e477d; /* EU Blue */
            --accent: #004494; 
            --bg: #ffffff; 
            --sidebar-bg: #f3f6f7;
            /* Font stack matching EU AI Act Explorer */
            --font-main: "Arial", "Helvetica", sans-serif; 
        }

        body { 
            font-family: var(--font-main); 
            margin: 0; 
            display: flex; 
            height: 100vh; 
            background: var(--bg); 
            overflow: hidden; 
            color: #333;
        }
        
        #sidebar { 
            width: 300px; 
            background: var(--sidebar-bg); 
            border-right: 1px solid #c5d1d8; 
            display: flex; 
            flex-direction: column; 
        }

        .sidebar-header { 
            padding: 20px; 
            background: var(--primary); 
            color: white; 
        }

        #article-list { flex: 1; overflow-y: auto; }
        
        .section-header { 
            padding: 12px 20px; 
            background: #e1e8ed; 
            font-weight: bold; 
            font-size: 0.75rem; 
            color: #555; 
            text-transform: uppercase; 
        }

        .nav-item { 
            padding: 15px 20px; 
            border-bottom: 1px solid #dbe3e8; 
            cursor: pointer; 
            transition: 0.2s;
        }

        .nav-item:hover { background: #e9eff2; }
        .nav-item.active { background: #ffffff; border-left: 5px solid var(--primary); font-weight: bold; }
        .nav-item small { display: block; color: #666; font-size: 0.8rem; margin-top: 4px; font-weight: normal; }

        #main-view { flex: 1; display: flex; flex-direction: column; background: white; }
        #content { flex: 1; padding: 40px 60px; overflow-y: auto; }
        
        h2#art-label { 
            font-size: 1.8rem; 
            color: var(--primary); 
            margin-bottom: 30px; 
            border-bottom: 1px solid #eee; 
            padding-bottom: 20px; 
        }

        .article-text { line-height: 1.6; font-size: 1.05rem; color: #222; }

        #recitals-panel { 
            width: 350px; 
            padding: 20px; 
            background: #f9f9f9; 
            border-left: 1px solid #eee; 
            overflow-y: auto; 
        }

        details { background: white; border: 1px solid #ddd; margin-bottom: 10px; padding: 12px; border-radius: 4px; }
        summary { cursor: pointer; font-weight: bold; color: var(--primary); outline: none; }
        .recital-content { padding-top: 10px; font-size: 0.9rem; border-top: 1px solid #f0f0f0; margin-top: 10px; }

        #diag { padding: 10px; background: #000; color: #0f0; font-family: monospace; font-size: 0.7rem; max-height: 80px; overflow-y: auto; }
    </style>
</head>
<body>
    <div id="sidebar">
        <div class="sidebar-header">
            <h2 style="margin:0; font-size: 1.2rem;">DMA Explorer</h2>
            <select id="language-select" onchange="loadLanguageData()" style="width:100%; margin-top:10px; padding:5px;">
                <option value="en">English (EN)</option>
                <option value="fr">Français (FR)</option>
                <option value="de">Deutsch (DE)</option>
            </select>
        </div>
        <div id="article-list"></div>
        <div id="diag">Initializing...</div>
    </div>

    <div id="main-view">
        <div id="content">
            <h2 id="art-label">Select a Provision</h2>
            <div id="art-text" class="article-text"></div>
        </div>
        <div id="resources" style="padding: 20px 60px; background: #f4f4f4; border-top: 1px solid #ddd;">
            <div id="resources-list"></div>
        </div>
    </div>

    <div id="recitals-panel">
        <h3 style="font-size: 0.9rem; text-transform: uppercase; color: #888;">Related Recitals</h3>
        <div id="recitals-list"></div>
    </div>

    <script>
        let dmaData = [];
        let masterLinks = [];

        function log(msg) { document.getElementById('diag').innerHTML += `<div>> ${msg}</div>`; }
        const getVal = (obj, key) => {
            if (!obj) return "";
            const k = Object.keys(obj).find(x => x.toLowerCase() === key.toLowerCase());
            return k ? obj[k] : "";
        };

        async function init() {
            try {
                const resp = await fetch('master_links.csv');
                const text = await resp.text();
                masterLinks = Papa.parse(text, { header: true, skipEmptyLines: true }).data;
                log("Master Links loaded: " + masterLinks.length);
                loadLanguageData();
            } catch (e) { log("Error: " + e.message); }
        }

        async function loadLanguageData() {
            const lang = document.getElementById('language-select').value;
            try {
                const resp = await fetch(`data/dma_${lang}.csv`);
                const text = await resp.text();
                dmaData = Papa.parse(text, { header: true, skipEmptyLines: true }).data;
                log(`${lang.toUpperCase()} data loaded: ` + dmaData.length);
                renderSidebar();
            } catch (e) { log("Error loading language: " + e.message); }
        }

        function renderSidebar() {
            const list = document.getElementById('article-list');
            const lang = document.getElementById('language-select').value;
            list.innerHTML = '<div class="section-header">Articles</div>';
            
            // Fix: Include both 'Article Paragraph' and 'Annex'
            const articles = dmaData.filter(r => {
                const type = getVal(r, 'Type').toLowerCase();
                return type.includes('article') || type.includes('annex');
            });
            
            log("Provisions found: " + articles.length);

            articles.forEach(row => {
                const id = getVal(row, 'ID');
                const map = masterLinks.find(m => getVal(m, 'ID') === id);
                
                // Use Title_FR/DE if available in master_links, else fallback
                const title_parsed = getVal(row, 'Title');
                const title_map = getVal(map, `Title_${lang.toUpperCase()}`) || getVal(map, 'Title');
                
                const div = document.createElement('div');
                div.className = 'nav-item'; div.id = `nav-${id}`;
                div.innerHTML = `<strong>${getVal(row, 'Label')}</strong><small>${title_parsed || title_map}</small>`;
                div.onclick = () => displayArticle(id);
                list.appendChild(div);
            });
        }

        function displayArticle(id) {
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            document.getElementById(`nav-${id}`)?.classList.add('active');

            const lang = document.getElementById('language-select').value;
            const row = dmaData.find(r => getVal(r, 'ID') === id);
            const map = masterLinks.find(m => getVal(m, 'ID') === id);

            const title = getVal(row, 'Title') || getVal(map, `Title_${lang.toUpperCase()}`) || getVal(map, 'Title');
            document.getElementById('art-label').innerText = `${getVal(row, 'Label')}: ${title}`;
            document.getElementById('art-text').innerHTML = getVal(row, 'Text');

            // Recitals
            const recList = document.getElementById('recitals-list');
            recList.innerHTML = '';
            const rel = getVal(map, 'Related_Recitals');
            if (rel) {
                rel.split(',').forEach(num => {
                    const r = dmaData.find(x => getVal(x, 'ID') === `REC_${num.trim()}`);
                    if (r) {
                        const d = document.createElement('details');
                        d.innerHTML = `<summary>Recital ${num.trim()}</summary><div class="recital-content">${getVal(r, 'Text')}</div>`;
                        recList.appendChild(d);
                    }
                });
            }

            // External Link
            const link = getVal(map, 'External_Links');
            const linkName = getVal(map, 'Link_Name') || "View official source ↗";
            document.getElementById('resources-list').innerHTML = link 
                ? `<a href="${link}" target="_blank" style="color:var(--primary); font-weight:bold; text-decoration:none;">${linkName}</a>`
                : '<span style="color:#999;">No external links available.</span>';
        }
        init();
    </script>
</body>
</html>
