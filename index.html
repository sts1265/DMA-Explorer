<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>DMA Explorer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        :root { --eu-blue: #0e477d; --sidebar-bg: #f3f6f7; --font-main: "Arial", sans-serif; }
        body { font-family: var(--font-main); margin: 0; display: flex; height: 100vh; overflow: hidden; background: #ddd; }
        
        /* Layout */
        #sidebar { width: 320px; min-width: 250px; background: var(--sidebar-bg); border-right: 1px solid #c5d1d8; display: flex; flex-direction: column; }
        #main-view { flex: 1; min-width: 400px; display: flex; flex-direction: column; background: white; position: relative; }
        #recitals-panel { width: 350px; min-width: 250px; background: #f9f9f9; border-left: 1px solid #c5d1d8; display: flex; flex-direction: column; }

        .resizer { width: 6px; cursor: col-resize; background: #eee; transition: 0.2s; z-index: 10; }
        .resizer:hover { background: var(--eu-blue); opacity: 0.5; }

        /* Content */
        .sidebar-header { padding: 20px; background: var(--eu-blue); color: white; }
        #article-list { flex: 1; overflow-y: auto; }
        #content { flex: 1; padding: 40px 60px; overflow-y: auto; position: relative; }
        
        /* Definitions UI */
        .defined-term { border-bottom: 1.5px dashed var(--eu-blue); cursor: help; color: inherit; }
        #definition-box { 
            position: fixed; display: none; z-index: 9999; width: 320px; 
            background: white; border: 2px solid var(--eu-blue); border-radius: 8px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.3); padding: 15px; font-size: 0.95rem;
            pointer-events: auto;
        }
        #definition-box h4 { margin: 0 0 10px 0; color: var(--eu-blue); border-bottom: 1px solid #eee; padding-bottom: 5px; }

        /* Sidebar items */
        .nav-item { padding: 12px 18px; border-bottom: 1px solid #dbe3e8; cursor: pointer; background: #fff; line-height: 1.4; }
        .nav-item.active { border-left: 6px solid var(--eu-blue); background: #f0f7ff; font-weight: bold; }
        .nav-item small { display: block; color: #666; font-size: 0.78rem; font-weight: normal; margin-top: 4px; }
        
        /* Links */
        #external-links-area { padding: 15px 60px; background: #f4f4f4; border-top: 1px solid #ddd; }
        .links-header { font-size: 0.75rem; font-weight: bold; color: #666; text-transform: uppercase; margin-bottom: 10px; }
        .ext-link { color: var(--eu-blue); text-decoration: none; font-weight: bold; font-size: 0.8rem; border: 1px solid var(--eu-blue); padding: 6px 12px; border-radius: 4px; background: white; display: inline-block; margin-right: 10px; }
        .ext-link::after { content: " ‚Üó"; font-size: 0.7rem; }

        details { background: white; border: 1px solid #ddd; margin-bottom: 10px; padding: 12px; border-radius: 4px; }
        summary { cursor: pointer; font-weight: bold; color: var(--eu-blue); font-size: 0.85rem; }
    </style>
</head>
<body>

    <div id="sidebar">
        <div class="sidebar-header">
            <h2 style="margin:0; font-size:1.1rem;">DMA Explorer</h2>
            <select id="language-select" onchange="loadLanguageData()" style="width:100%; margin-top:10px; padding:5px;">
                <option value="en">English (EN)</option>
                <option value="fr">Fran√ßais (FR)</option>
                <option value="de">Deutsch (DE)</option>
            </select>
        </div>
        <div id="article-list"></div>
    </div>

    <div class="resizer" id="resizer-left"></div>

    <div id="main-view">
        <div id="content">
            <div id="definition-box">
                <h4 id="def-title">Term</h4>
                <div id="def-text">...</div>
            </div>
            <h2 id="art-label" style="color:var(--eu-blue); border-bottom: 2px solid #eee; padding-bottom: 10px;">Select a Provision</h2>
            <div id="art-text" style="line-height: 1.8; font-size: 1.1rem; color: #222;"></div>
        </div>
        <div id="external-links-area">
            <div class="links-header">External References üåê</div>
            <div id="links-container"></div>
        </div>
    </div>

    <div class="resizer" id="resizer-right"></div>

    <div id="recitals-panel">
        <div style="padding: 15px; background: #eee; font-weight: bold; font-size: 0.75rem; color: #555; border-bottom: 1px solid #ddd;">RELATED REFERENCES</div>
        <div id="recitals-list" style="padding: 20px; overflow-y: auto; flex: 1;"></div>
    </div>

    <script>
        let dmaData = [];
        let masterLinks = [];
        let definitions = {
            "gatekeeper": "An undertaking providing core platform services, designated pursuant to Article 3.",
            "core platform service": "Any of the services listed in Article 2(2), including online intermediation, search engines, social networking, video-sharing, etc.",
            "information society service": "Any service as defined in Article 1(1), point (b), of Directive (EU) 2015/1535.",
            "digital sector": "The sector of products and services provided by means of, or through, information society services.",
            "online intermediation services": "Services as defined in Article 2, point (2), of Regulation (EU) 2019/1150.",
            "online search engine": "A service as defined in Article 2, point (5), of Regulation (EU) 2019/1150.",
            "online social networking service": "A platform enabling end users to connect, communicate, share content and discover other users.",
            "video-sharing platform service": "A service as defined in Article 1(1), point (aa), of Directive 2010/13/EU.",
            "number-independent interpersonal communications service": "A service as defined in Article 2, point (7), of Directive (EU) 2018/1972.",
            "operating system": "System software that controls hardware/software functions and enables applications to run.",
            "web browser": "Software application enabling end users to access and interact with web content.",
            "virtual assistant": "Software that processes demands/tasks (audio, visual, etc.) to provide access to services or control devices.",
            "cloud computing service": "A service as defined in Article 4, point (19), of Directive (EU) 2016/1148.",
            "software application stores": "Online intermediation services focused on software applications.",
            "software application": "Any digital product or service that runs on an operating system.",
            "payment service": "A service as defined in Article 4, point (3) of Directive (EU) 2015/2366.",
            "technical service supporting payment service": "A service within the meaning of Article 3, point (j), of Directive (EU) 2015/2366.",
            "payment system for in-app purchases": "Software/service facilitating purchases of digital content or services within an app.",
            "identification service": "Service enabling verification of identity for end users or business users.",
            "end user": "Any natural or legal person using core platform services other than as a business user.",
            "business user": "Natural or legal person acting in commercial capacity using core platform services to provide goods/services to end users.",
            "ranking": "Relative prominence given to goods/services or search results by online platforms.",
            "search results": "Information in any format returned in response to a search query.",
            "data": "Digital representation of acts, facts or information.",
            "personal data": "Data as defined in Article 4, point (1), of Regulation (EU) 2016/679.",
            "non-personal data": "Data other than personal data.",
            "undertaking": "Entity engaged in economic activity, including all linked enterprises forming a group.",
            "control": "Possibility of exercising decisive influence on an undertaking (Reg 139/2004).",
            "interoperability": "Ability to exchange and mutually use information through interfaces so elements work together.",
            "turnover": "Amount derived by an undertaking within the meaning of Article 5(1) of Regulation (EC) No 139/2004.",
            "profiling": "As defined in Article 4, point (4), of Regulation (EU) 2016/679.",
            "consent": "As defined in Article 4, point (11), of Regulation (EU) 2016/679.",
            "national court": "Court or tribunal of a Member State within the meaning of Article 267 TFEU."
        };

        const getVal = (row, key) => {
            if (!row) return "";
            const k = Object.keys(row).find(x => x.trim().toLowerCase() === key.toLowerCase());
            return k ? row[k].trim() : "";
        };

        // Resizer Implementation
        function initResizers() {
            const leftR = document.getElementById('resizer-left'), rightR = document.getElementById('resizer-right');
            const sidebar = document.getElementById('sidebar'), panel = document.getElementById('recitals-panel');
            
            leftR.onmousedown = (e) => {
                document.onmousemove = (e) => sidebar.style.width = e.clientX + 'px';
                document.onmouseup = () => document.onmousemove = null;
            };
            rightR.onmousedown = (e) => {
                document.onmousemove = (e) => panel.style.width = (window.innerWidth - e.clientX) + 'px';
                document.onmouseup = () => document.onmousemove = null;
            };
        }

        async function init() {
            initResizers();
            const resp = await fetch('master_links.csv');
            const text = await resp.text();
            masterLinks = Papa.parse(text, { header: true, skipEmptyLines: true, delimiter: ";" }).data;
            loadLanguageData();
        }

        async function loadLanguageData() {
            const lang = document.getElementById('language-select').value;
            const resp = await fetch(`data/dma_${lang}.csv`);
            const text = await resp.text();
            dmaData = Papa.parse(text, { header: true, skipEmptyLines: true }).data;
            renderSidebar();
        }

        function resolveTitle(row, map, lang, id) {
            const extracted = getVal(row, 'Title');
            const csvLang = getVal(map, `Title_${lang.toUpperCase()}`);
            const csvUnofficial = getVal(map, 'Title');
            
            // Sub-paragraphs: CSV Title is higher priority
            if (id.includes('_') && id.split('_').length > 2) {
                return csvLang || csvUnofficial || extracted;
            }
            return csvLang || extracted || csvUnofficial;
        }

        function renderSidebar() {
            const list = document.getElementById('article-list'), lang = document.getElementById('language-select').value;
            list.innerHTML = '';
            dmaData.forEach(row => {
                if (getVal(row, 'Type') === 'Chapter') {
                    const div = document.createElement('div');
                    div.style = "padding:10px 15px; font-size:0.7rem; font-weight:bold; background:#e1e8ed; color:#555;";
                    div.innerText = getVal(row, 'Label').toUpperCase();
                    list.appendChild(div);
                } else if (getVal(row, 'Type') !== 'Recital') {
                    const id = getVal(row, 'ID');
                    const map = masterLinks.find(m => getVal(m, 'ID') === id);
                    const div = document.createElement('div');
                    div.className = 'nav-item'; div.id = 'nav-' + id;
                    div.innerHTML = `<strong>${getVal(row, 'Label')}</strong><small>${resolveTitle(row, map, lang, id)}</small>`;
                    div.onclick = () => displayContent(id);
                    list.appendChild(div);
                }
            });
        }

        function displayContent(id) {
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('nav-'+id)?.classList.add('active');
            
            const lang = document.getElementById('language-select').value;
            const row = dmaData.find(r => getVal(r, 'ID') === id);
            const map = masterLinks.find(m => getVal(m, 'ID') === id);
            
            document.getElementById('art-label').innerText = `${getVal(row, 'Label')}: ${resolveTitle(row, map, lang, id)}`;
            
            // Highlight Definitions
            let text = getVal(row, 'Text');
            if (!id.startsWith('Article_2')) {
                // Sort keys by length descending to match longest phrases first (e.g. 'core platform service' before 'service')
                const sortedTerms = Object.keys(definitions).sort((a,b) => b.length - a.length);
                sortedTerms.forEach(term => {
                    const regex = new RegExp(`\\b(${term}s?)\\b`, 'gi');
                    text = text.replace(regex, `<span class="defined-term" onclick="showDef(event, '$1')">$1</span>`);
                });
            }
            document.getElementById('art-text').innerHTML = text;

            // Recitals / References Panel
            const sideList = document.getElementById('recitals-list');
            sideList.innerHTML = '';
            const relRecs = getVal(map, 'Related_Recitals').split(',').map(s => s.trim());
            
            relRecs.forEach(ref => {
                if (!ref) return;
                const isAnnex = ref.toLowerCase() === 'annex';
                const searchId = isAnnex ? "ANNEX_MAIN" : `REC_${ref}`;
                const refData = dmaData.find(x => getVal(x, 'ID') === searchId);
                if (refData) {
                    const d = document.createElement('details');
                    d.innerHTML = `<summary>${isAnnex ? 'Annex' : 'Recital ' + ref}</summary><div style="font-size:0.85rem; padding:10px;">${getVal(refData, 'Text')}</div>`;
                    sideList.appendChild(d);
                }
            });

            // Links
            const container = document.getElementById('links-container');
            container.innerHTML = '';
            getVal(map, 'External_Links').split('|').forEach(linkStr => {
                if (!linkStr.trim()) return;
                let [name, url] = linkStr.split('>');
                const a = document.createElement('a');
                a.className = 'ext-link'; a.href = (url || name).trim(); a.target = "_blank";
                a.innerText = name.trim();
                container.appendChild(a);
            });
            document.getElementById('content').scrollTop = 0;
        }

        function showDef(event, clickedText) {
            event.stopPropagation();
            const box = document.getElementById('definition-box');
            // Find base term (singular or exact match)
            let base = clickedText.toLowerCase();
            if (!definitions[base] && base.endsWith('s')) base = base.slice(0, -1);
            if (!definitions[base]) base = Object.keys(definitions).find(k => clickedText.toLowerCase().includes(k)) || base;

            document.getElementById('def-title').innerText = base.toUpperCase();
            document.getElementById('def-text').innerText = definitions[base] || "Definition contextually linked to Article 2.";
            
            box.style.display = 'block';
            
            // Viewport collision detection
            let x = event.clientX + 20;
            let y = event.clientY - 20;
            
            if (x + 340 > window.innerWidth) x = window.innerWidth - 350;
            if (y + 200 > window.innerHeight) y = window.innerHeight - 220;

            box.style.left = x + 'px';
            box.style.top = y + 'px';
        }

        window.onclick = () => document.getElementById('definition-box').style.display = 'none';
        init();
    </script>
</body>
</html>
