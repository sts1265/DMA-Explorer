<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DMA Explorer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        :root { --eu-blue: #0e477d; --sidebar-bg: #f3f6f7; --font-main: "Arial", sans-serif; --border-color: #c5d1d8; }
        
        /* Desktop Layout */
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; background: #fff; }
        body { font-family: var(--font-main); display: flex; width: 100vw; }
        
        #sidebar { 
            width: 320px; min-width: 280px; background: var(--sidebar-bg); 
            border-right: 1px solid var(--border-color); display: flex; 
            flex-direction: column; height: 100vh; transition: transform 0.3s ease;
        }

        #main-view { 
            flex: 1; display: flex; flex-direction: column; 
            height: 100vh; min-width: 0; background: white;
        }

        #recitals-panel { 
            width: 350px; min-width: 300px; background: #f9f9f9; 
            border-left: 1px solid var(--border-color); display: flex; 
            flex-direction: column; height: 100vh; transition: transform 0.3s ease;
        }

        /* Mobile Header - Permanently Pinned */
        #mobile-nav-bar { 
            display: none; background: var(--eu-blue); color: white; 
            padding: 10px; justify-content: space-between; position: fixed; 
            top: 0; left: 0; width: 100%; box-sizing: border-box; z-index: 3000; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .mob-btn { 
            background: rgba(255,255,255,0.15); border: 1px solid white; color: white; 
            padding: 8px 12px; border-radius: 4px; font-size: 0.75rem; cursor: pointer;
            transition: opacity 0.3s;
        }
        .mob-btn:disabled { opacity: 0.3; cursor: not-allowed; border-color: rgba(255,255,255,0.3); }

        /* Sidebar UI */
        .sidebar-header { padding: 20px; background: var(--eu-blue); color: white; flex-shrink: 0; }
        #article-list { flex: 1; overflow-y: auto; border-top: 1px solid rgba(0,0,0,0.1); }
        .nav-item { padding: 12px 18px; border-bottom: 1px solid #dbe3e8; cursor: pointer; background: #fff; line-height: 1.4; }
        .nav-item.active { border-left: 6px solid var(--eu-blue); background: #f0f7ff; font-weight: bold; }
        .nav-item small { display: block; color: #666; font-size: 0.78rem; font-weight: normal; margin-top: 4px; }
        .chapter-header { padding: 10px 15px; font-size: 0.7rem; font-weight: bold; background: #e1e8ed; color: #555; text-transform: uppercase; }

        /* Content UI */
        #content { flex: 1; padding: 40px; overflow-y: auto; position: relative; word-wrap: break-word; }
        .defined-term { border-bottom: 1.5px dashed var(--eu-blue); cursor: help; }
        #definition-box { position: fixed; display: none; z-index: 9999; width: 300px; background: white; border: 2px solid var(--eu-blue); border-radius: 8px; padding: 18px; }

        /* External Links area */
        #external-links-area { padding: 15px 40px; background: #f4f4f4; border-top: 1px solid #ddd; flex-shrink: 0; transition: transform 0.3s ease; }
        .ext-link { color: var(--eu-blue); text-decoration: none; font-weight: bold; font-size: 0.8rem; border: 1px solid var(--eu-blue); padding: 8px 12px; border-radius: 4px; background: white; display: inline-block; margin: 5px 10px 5px 0; }

        /* Recitals UI */
        #recitals-list details { background: white; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 12px; }
        #recitals-list summary { padding: 12px; font-weight: bold; color: var(--eu-blue); cursor: pointer; }
        #recitals-list .ref-content { padding: 15px; font-size: 0.9rem; border-top: 1px solid #eee; }

        /* Backdrop */
        #backdrop { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 2000; }

        /* MOBILE UX OVERRIDES */
        @media (max-width: 850px) {
            #mobile-nav-bar { display: flex; }
            #main-view { min-width: 100%; padding-top: 60px; /* Space for sticky header */ }
            #art-text { font-size: 0.95rem; text-align: left; }
            #content { padding: 20px; width: 100%; box-sizing: border-box; }
            
            /* Panels restricted to 85% width so you can always see/tap the backdrop to close */
            #sidebar { position: fixed; left: 0; top: 0; width: 85% !important; transform: translateX(-100%); z-index: 2500; }
            #recitals-panel { position: fixed; right: 0; top: 0; width: 85% !important; transform: translateX(100%); z-index: 2500; }
            
            #external-links-area { 
                position: fixed; right: 0; top: 0; width: 85% !important; height: 100vh; 
                transform: translateX(100%); z-index: 2500; background: #fff; padding: 80px 20px 20px;
                box-sizing: border-box; overflow-y: auto;
            }
            .ext-link { display: block; margin-right: 0; text-align: center; }

            body.sidebar-open #sidebar { transform: translateX(0); }
            body.recitals-open #recitals-panel { transform: translateX(0); }
            body.links-open #external-links-area { transform: translateX(0); }
            body.any-panel-open #backdrop { display: block; }
        }
    </style>
</head>
<body id="body-tag">

    <div id="backdrop" onclick="closeAllPanels()"></div>

    <div id="mobile-nav-bar">
        <button class="mob-btn" onclick="togglePanel('sidebar')">â˜° Articles</button>
        <div>
            <button id="btn-links" class="mob-btn" onclick="togglePanel('links')" disabled>ðŸ”— Links</button>
            <button id="btn-rec" class="mob-btn" onclick="togglePanel('recitals')" disabled>âš– Ref</button>
        </div>
    </div>

    <div id="sidebar">
        <div class="sidebar-header">
            <h2 style="margin:0; font-size:1rem;">DMA Explorer</h2>
            <select id="language-select" onchange="loadLanguageData()" style="width:100%; margin-top:10px; padding:5px;">
                <option value="en">English (EN)</option>
                <option value="fr">FranÃ§ais (FR)</option>
                <option value="de">Deutsch (DE)</option>
            </select>
        </div>
        <div id="article-list"></div>
    </div>

    <div id="main-view">
        <div id="content">
            <div id="definition-box"><h4 id="def-title" style="margin:0; color:var(--eu-blue);">Term</h4><div id="def-text">...</div></div>
            <h2 id="art-label" style="color:var(--eu-blue); border-bottom: 2px solid #eee; padding-bottom: 12px; margin-top: 0;">Select a Provision</h2>
            <div id="art-text" style="line-height: 1.6;"></div>
        </div>
        <div id="external-links-area">
            <div style="font-weight:bold; margin-bottom:15px; font-size:0.9rem; color:#666; border-bottom:1px solid #eee; padding-bottom:10px;">PROVISION LINKS</div>
            <div id="links-container"></div>
        </div>
    </div>

    <div id="recitals-panel">
        <div style="padding: 15px; background: var(--eu-blue); color:white; font-weight: bold; font-size: 0.75rem;">RELATED REFERENCES</div>
        <div id="recitals-list" style="padding: 20px; overflow-y: auto; flex: 1;"></div>
    </div>

    <script>
        function togglePanel(panel) {
            const b = document.getElementById('body-tag');
            const isOpen = b.classList.contains(panel + '-open');
            closeAllPanels();
            if (!isOpen) {
                b.classList.add(panel + '-open');
                b.classList.add('any-panel-open');
            }
        }
        function closeAllPanels() {
            const b = document.getElementById('body-tag');
            b.classList.remove('sidebar-open', 'recitals-open', 'links-open', 'any-panel-open');
        }

        let dmaData = [], masterLinks = [], definitionsMap = new Map();

        const getVal = (row, key) => {
            if (!row) return "";
            const k = Object.keys(row).find(x => x.trim().toLowerCase() === key.toLowerCase());
            return k ? row[k].trim() : "";
        };

        function resolveTitle(row, map, lang, id) {
            const extracted = getVal(row, 'Title'), csvLang = getVal(map, `Title_${lang.toUpperCase()}`);
            if (id.includes('_') && id.split('_').length > 2) return csvLang || getVal(map, 'Title') || extracted;
            return csvLang || extracted || getVal(map, 'Title');
        }

        async function init() {
            try {
                await Promise.all([loadDefinitions(), loadMasterLinks()]);
                await loadLanguageData();
            } catch (e) { console.error("Init failed", e); }
        }

        async function loadDefinitions() {
            const resp = await fetch('definitions.csv');
            const text = await resp.text();
            const data = Papa.parse(text.replace(/\xa0/g, ' '), { header: true, skipEmptyLines: true, delimiter: ";" }).data;
            data.forEach(row => {
                const term = getVal(row, 'notion'), def = getVal(row, 'exact definition');
                if (term && def) definitionsMap.set(term.toLowerCase(), def);
            });
        }

        async function loadMasterLinks() {
            const resp = await fetch('master_links.csv');
            const text = await resp.text();
            masterLinks = Papa.parse(text, { header: true, skipEmptyLines: true, delimiter: ";" }).data;
        }

        async function loadLanguageData() {
            const lang = document.getElementById('language-select').value;
            const resp = await fetch(`data/dma_${lang}.csv`);
            const text = await resp.text();
            dmaData = Papa.parse(text, { header: true, skipEmptyLines: true }).data;
            renderSidebar();
        }

        function renderSidebar() {
            const list = document.getElementById('article-list'), lang = document.getElementById('language-select').value;
            list.innerHTML = '';
            const recDetails = document.createElement('details');
            recDetails.innerHTML = `<summary style="padding:12px; background:#e1e8ed; font-weight:bold; font-size:0.75rem; cursor:pointer;">â–¶ RECITALS</summary><div id="rec-nav-list"></div>`;
            list.appendChild(recDetails);
            const recNavList = recDetails.querySelector('#rec-nav-list');

            dmaData.forEach(row => {
                const type = getVal(row, 'Type'), id = getVal(row, 'ID'), label = getVal(row, 'Label');
                if (type === 'Recital') {
                    const div = document.createElement('div');
                    div.className = 'nav-item'; div.style.paddingLeft = "30px";
                    div.innerHTML = `<strong>${label}</strong>`;
                    div.onclick = () => { displayContent(id); closeAllPanels(); };
                    recNavList.appendChild(div);
                } else if (type === 'Chapter') {
                    const div = document.createElement('div');
                    div.className = 'chapter-header';
                    div.innerText = label;
                    list.appendChild(div);
                } else {
                    const map = masterLinks.find(m => getVal(m, 'ID') === id);
                    const div = document.createElement('div');
                    div.className = 'nav-item'; div.id = 'nav-' + id;
                    div.innerHTML = `<strong>${label}</strong><small>${resolveTitle(row, map, lang, id)}</small>`;
                    div.onclick = () => { displayContent(id); closeAllPanels(); };
                    list.appendChild(div);
                }
            });
        }

        function displayContent(id) {
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('nav-'+id)?.classList.add('active');
            const lang = document.getElementById('language-select').value, row = dmaData.find(r => getVal(r, 'ID') === id), map = masterLinks.find(m => getVal(m, 'ID') === id);
            if (!row) return;

            document.getElementById('art-label').innerText = `${getVal(row, 'Label')}: ${resolveTitle(row, map, lang, id)}`;
            let textHtml = getVal(row, 'Text').replace(/\xa0/g, ' ');
            if (!id.startsWith('Article_2') && definitionsMap.size > 0) {
                const sortedTerms = Array.from(definitionsMap.keys()).sort((a,b) => b.length - a.length);
                sortedTerms.forEach(term => {
                    const regex = new RegExp(`\\b(${term}s?)\\b(?![^<]*>|[^<>]*<\/span>)`, 'gi');
                    textHtml = textHtml.replace(regex, `<span class="defined-term" onclick="showDef(event, '${term}')">$1</span>`);
                });
            }
            document.getElementById('art-text').innerHTML = textHtml;

            // Related Recitals
            const sideList = document.getElementById('recitals-list'); sideList.innerHTML = '';
            const recBtn = document.getElementById('btn-rec');
            if (map && getVal(map, 'Related_Recitals')) {
                recBtn.disabled = false;
                getVal(map, 'Related_Recitals').split(',').forEach(ref => {
                    const cleanRef = ref.trim(), searchId = cleanRef.toLowerCase() === 'annex' ? "ANNEX_MAIN" : `REC_${cleanRef}`;
                    const refData = dmaData.find(x => getVal(x, 'ID') === searchId);
                    if (refData) {
                        const d = document.createElement('details');
                        d.innerHTML = `<summary>${cleanRef.toLowerCase() === 'annex' ? 'Annex' : 'Recital ' + cleanRef}</summary><div class="ref-content">${getVal(refData, 'Text')}</div>`;
                        sideList.appendChild(d);
                    }
                });
            } else { recBtn.disabled = true; }

            // External Links
            const linksArea = document.getElementById('external-links-area'), container = document.getElementById('links-container'), linkBtn = document.getElementById('btn-links');
            container.innerHTML = '';
            const linkData = getVal(map, 'External_Links');
            if (linkData) {
                linkBtn.disabled = false;
                linkData.split('|').forEach(item => {
                    let [name, url] = item.split('>');
                    const a = document.createElement('a'); a.className = 'ext-link'; a.href = (url || name).trim(); a.target = "_blank"; a.innerText = name.trim();
                    container.appendChild(a);
                });
            } else { linkBtn.disabled = true; if(window.innerWidth > 850) linksArea.style.display = 'none'; }
            
            document.getElementById('content').scrollTop = 0;
        }

        function showDef(event, termKey) {
            event.stopPropagation();
            const box = document.getElementById('definition-box');
            document.getElementById('def-title').innerText = termKey.toUpperCase();
            document.getElementById('def-text').innerText = definitionsMap.get(termKey.toLowerCase());
            box.style.display = 'block';
            box.style.left = (window.innerWidth < 850) ? '10%' : event.clientX + 'px';
            box.style.top = (window.innerWidth < 850) ? '20%' : (event.clientY - 20) + 'px';
        }

        window.onclick = () => document.getElementById('definition-box').style.display = 'none';
        init();
    </script>
</body>
</html>
