<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>DMA Explorer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        :root { --eu-blue: #0e477d; --sidebar-bg: #f3f6f7; --font-main: "Arial", sans-serif; }
        
        /* Layout with Resizable Columns */
        body { font-family: var(--font-main); margin: 0; display: flex; height: 100vh; overflow: hidden; background: #ddd; }
        
        #sidebar { width: 300px; min-width: 200px; background: var(--sidebar-bg); border-right: 1px solid #c5d1d8; display: flex; flex-direction: column; height: 100%; }
        
        #main-view { flex: 1; min-width: 400px; display: flex; flex-direction: column; background: white; border-right: 1px solid #c5d1d8; }
        
        #recitals-panel { width: 350px; min-width: 200px; background: #f9f9f9; padding: 0; display: flex; flex-direction: column; height: 100%; }

        /* Resizer Bars */
        .resizer { width: 8px; cursor: col-resize; background: #eee; transition: background 0.2s; }
        .resizer:hover { background: var(--eu-blue); opacity: 0.3; }

        /* Content Areas */
        .sidebar-header { padding: 20px; background: var(--eu-blue); color: white; }
        #article-list { flex: 1; overflow-y: auto; }
        #content { flex: 1; padding: 40px 60px; overflow-y: auto; position: relative; }
        
        /* Links Section */
        #external-links-area { padding: 15px 60px; background: #f4f4f4; border-top: 1px solid #ddd; }
        .links-header { font-size: 0.75rem; font-weight: bold; color: #666; text-transform: uppercase; margin-bottom: 10px; display: flex; align-items: center; gap: 5px; }
        .links-container { display: flex; gap: 12px; flex-wrap: wrap; }
        .ext-link { color: var(--eu-blue); text-decoration: none; font-weight: bold; font-size: 0.8rem; border: 1px solid var(--eu-blue); padding: 6px 12px; border-radius: 4px; background: white; }
        .ext-link::after { content: " ‚Üó"; font-size: 0.7rem; }

        /* Definitions Logic */
        .defined-term { border-bottom: 1px dashed var(--eu-blue); cursor: help; color: inherit; text-decoration: none; }
        .defined-term:hover { background-color: rgba(14, 71, 125, 0.1); }
        
        #definition-box { 
            position: absolute; display: none; z-index: 1000; width: 300px; 
            background: white; border: 2px solid var(--eu-blue); border-radius: 8px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); padding: 15px; font-size: 0.9rem;
        }
        #definition-box h4 { margin: 0 0 8px 0; color: var(--eu-blue); font-size: 0.95rem; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        #definition-box .close-def { float: right; cursor: pointer; font-weight: bold; }

        /* Sidebar items */
        .nav-item { padding: 12px 15px; border-bottom: 1px solid #dbe3e8; cursor: pointer; background: #fff; }
        .nav-item.active { border-left: 5px solid var(--eu-blue); background: #f0f7ff; }
        .nav-item small { display: block; color: #777; font-size: 0.75rem; }
    </style>
</head>
<body>

    <div id="sidebar">
        <div class="sidebar-header">
            <h2 style="margin:0; font-size:1.1rem;">DMA Explorer</h2>
            <select id="language-select" onchange="loadLanguageData()" style="width:100%; margin-top:10px;">
                <option value="en">English (EN)</option>
                <option value="fr">Fran√ßais (FR)</option>
                <option value="de">Deutsch (DE)</option>
            </select>
        </div>
        <div id="article-list"></div>
    </div>

    <div class="resizer" id="resizer-left"></div>

    <div id="main-view">
        <div id="content">
            <div id="definition-box">
                <span class="close-def" onclick="hideDef()">√ó</span>
                <h4 id="def-title">Term</h4>
                <div id="def-text">Definition goes here...</div>
            </div>
            <h2 id="art-label" style="color:var(--eu-blue)">Select a Provision</h2>
            <div id="art-text" class="article-text">...</div>
        </div>
        <div id="external-links-area">
            <div class="links-header">External References üåê</div>
            <div id="links-container" class="links-container"></div>
        </div>
    </div>

    <div class="resizer" id="resizer-right"></div>

    <div id="recitals-panel">
        <div style="padding: 20px; border-bottom: 1px solid #ddd; background: #eee; font-weight: bold; font-size: 0.8rem; color: #555;">RELATED REFERENCES</div>
        <div id="recitals-list" style="padding: 20px; overflow-y: auto; flex: 1;"></div>
    </div>

    <script>
        let dmaData = [];
        let masterLinks = [];
        let definitions = {};

        const getVal = (row, key) => {
            if (!row) return "";
            const k = Object.keys(row).find(x => x.trim().toLowerCase() === key.toLowerCase());
            return k ? row[k].trim() : "";
        };

        // --- Resize Logic ---
        function initResizers() {
            const leftResizer = document.getElementById('resizer-left');
            const rightResizer = document.getElementById('resizer-right');
            const sidebar = document.getElementById('sidebar');
            const panel = document.getElementById('recitals-panel');

            leftResizer.addEventListener('mousedown', (e) => {
                document.addEventListener('mousemove', resizeLeft);
                document.addEventListener('mouseup', () => document.removeEventListener('mousemove', resizeLeft));
            });

            rightResizer.addEventListener('mousedown', (e) => {
                document.addEventListener('mousemove', resizeRight);
                document.addEventListener('mouseup', () => document.removeEventListener('mousemove', resizeRight));
            });

            function resizeLeft(e) { sidebar.style.width = e.clientX + 'px'; }
            function resizeRight(e) { panel.style.width = (window.innerWidth - e.clientX) + 'px'; }
        }

        // --- Definition Extractor ---
        function extractDefinitions() {
            definitions = {};
            const art2 = dmaData.filter(r => getVal(r, 'ID').startsWith('Article_2'));
            art2.forEach(row => {
                const text = getVal(row, 'Text');
                // Regex to find: ‚Äòterm‚Äô means... or "term" means...
                const regex = /[‚Äò'"]([^‚Äô'"]+)[‚Äô'"]\s+(?:means|signifie|bedeutet)/gi;
                let match;
                while ((match = regex.exec(text)) !== null) {
                    definitions[match[1].toLowerCase()] = text.split(match[0])[1].split(';')[0] + '.';
                }
            });
        }

        function highlightDefinitions(html, currentId) {
            if (currentId.startsWith('Article_2')) return html;
            let newHtml = html;
            Object.keys(definitions).forEach(term => {
                const regex = new RegExp(`\\b(${term})\\b`, 'gi');
                newHtml = newHtml.replace(regex, `<span class="defined-term" onclick="showDef(event, '$1')">$1</span>`);
            });
            return newHtml;
        }

        function showDef(event, term) {
            const box = document.getElementById('definition-box');
            document.getElementById('def-title').innerText = term.charAt(0).toUpperCase() + term.slice(1);
            document.getElementById('def-text').innerText = definitions[term.toLowerCase()] || "Definition not found.";
            box.style.display = 'block';
            box.style.top = (event.pageY - 50) + 'px';
            box.style.left = (event.pageX + 20) + 'px';
            event.stopPropagation();
        }

        function hideDef() { document.getElementById('definition-box').style.display = 'none'; }

        // --- Main App Logic ---
        async function init() {
            initResizers();
            const resp = await fetch('master_links.csv');
            const text = await resp.text();
            masterLinks = Papa.parse(text, { header: true, skipEmptyLines: true, delimiter: ";" }).data;
            loadLanguageData();
        }

        async function loadLanguageData() {
            const lang = document.getElementById('language-select').value;
            const resp = await fetch(`data/dma_${lang}.csv`);
            const text = await resp.text();
            dmaData = Papa.parse(text, { header: true, skipEmptyLines: true }).data;
            extractDefinitions();
            renderSidebar();
        }

        function renderSidebar() {
            const list = document.getElementById('article-list');
            list.innerHTML = '';
            dmaData.forEach(row => {
                if (getVal(row, 'Type') === 'Chapter') {
                    const div = document.createElement('div');
                    div.style = "padding:10px 15px; font-size:0.7rem; font-weight:bold; background:#e1e8ed;";
                    div.innerText = getVal(row, 'Label');
                    list.appendChild(div);
                } else if (getVal(row, 'Type') !== 'Recital') {
                    const div = document.createElement('div');
                    div.className = 'nav-item';
                    div.id = 'nav-' + getVal(row, 'ID');
                    div.innerHTML = `<strong>${getVal(row, 'Label')}</strong><small>${getVal(row, 'Title')}</small>`;
                    div.onclick = () => displayContent(getVal(row, 'ID'));
                    list.appendChild(div);
                }
            });
        }

        function displayContent(id) {
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('nav-'+id)?.classList.add('active');
            
            const row = dmaData.find(r => getVal(r, 'ID') === id);
            const map = masterLinks.find(m => getVal(m, 'ID') === id);
            
            document.getElementById('art-label').innerText = getVal(row, 'Label') + ": " + getVal(row, 'Title');
            
            // Apply definition highlighting
            const cleanText = getVal(row, 'Text');
            document.getElementById('art-text').innerHTML = highlightDefinitions(cleanText, id);

            // Links logic
            const container = document.getElementById('links-container');
            container.innerHTML = '';
            getVal(map, 'External_Links').split('|').forEach(linkStr => {
                if (!linkStr.trim()) return;
                let [name, url] = linkStr.split('>');
                const a = document.createElement('a');
                a.className = 'ext-link';
                a.href = (url || name).trim();
                a.target = "_blank";
                a.innerText = name.trim();
                container.appendChild(a);
            });
        }

        document.body.onclick = hideDef;
        init();
    </script>
</body>
</html>
